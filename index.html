<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>–°—á—ë—Ç—á–∏–∫ —Ä—É–ª–æ–Ω–æ–≤</title>
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;–°—á—ë—Ç—á–∏–∫ —Ä—É–ª–æ–Ω–æ–≤&quot;,&quot;short_name&quot;:&quot;–†—É–ª–æ–Ω—ã&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%231a1a2e&quot;,&quot;theme_color&quot;:&quot;%231a1a2e&quot;}">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
      min-height: 100vh;
      color: #e2e8f0;
      padding: 16px;
      padding-bottom: 100px;
    }
    
    .header {
      text-align: center;
      padding: 20px 0;
    }
    
    .header h1 {
      font-size: 24px;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }
    
    .header p { color: #94a3b8; font-size: 14px; }
    
    .card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .upload-zone {
      border: 2px dashed rgba(148, 163, 184, 0.4);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .upload-zone:active {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }
    
    .upload-zone .icon { font-size: 48px; margin-bottom: 12px; }
    .upload-zone .text { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .upload-zone .hint { font-size: 13px; color: #94a3b8; }
    
    .btn-row {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
      background: rgba(71, 85, 105, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #cbd5e1;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
    }
    
    .btn:disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .image-container {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #0f0f23;
      margin-bottom: 16px;
    }
    
    .image-container img {
      width: 100%;
      max-height: 50vh;
      object-fit: contain;
      display: block;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 10;
    }
    
    .markers-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #22c55e;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    
    .input-field {
      width: 100%;
      padding: 14px 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      color: #e2e8f0;
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .result-box {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .result-count {
      font-size: 56px;
      font-weight: 700;
      color: #22c55e;
      line-height: 1;
    }
    
    .result-label {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    
    .result-details {
      margin-top: 16px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 14px;
      color: #cbd5e1;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    
    .confidence-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .confidence-high { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .confidence-medium { background: rgba(234, 179, 8, 0.2); color: #eab308; }
    .confidence-low { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(30, 41, 59, 0.8));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-value { font-size: 28px; font-weight: 700; color: #60a5fa; }
    .stat-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; }
    
    .history-item {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px;
      background: rgba(30, 41, 59, 0.6);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    
    .history-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .history-item .info { flex: 1; }
    .history-item .title { font-weight: 600; font-size: 14px; }
    .history-item .time { font-size: 12px; color: #94a3b8; }
    .history-item .count { font-size: 24px; font-weight: 700; color: #22c55e; }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text {
      margin-top: 16px;
      color: #94a3b8;
      font-size: 14px;
    }
    
    .settings-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .settings-row input {
      flex: 1;
      min-width: 200px;
    }
    
    .error-box {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: #fca5a5;
    }
    
    .hidden { display: none !important; }
    
    .toggle-btn {
      padding: 8px 16px;
      background: rgba(71, 85, 105, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 8px;
      color: #cbd5e1;
      font-size: 13px;
      cursor: pointer;
    }
    
    .toggle-btn.active {
      background: rgba(59, 130, 246, 0.3);
      border-color: rgba(59, 130, 246, 0.5);
      color: #60a5fa;
    }

    .api-setup {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .api-setup h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #60a5fa;
    }
    
    .api-setup p {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    
    .api-setup a {
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="font-size: 40px; margin-bottom: 8px;">üì¶</div>
    <h1>–°—á—ë—Ç—á–∏–∫ —Ä—É–ª–æ–Ω–æ–≤</h1>
    <p>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Å Gemini AI</p>
  </div>

  <!-- Stats -->
  <div id="stats" class="stats-row hidden">
    <div class="stat-card">
      <div class="stat-value" id="stat-pallets">0</div>
      <div class="stat-label">–ü–∞–ª–ª–µ—Ç</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-rolls">0</div>
      <div class="stat-label">–†—É–ª–æ–Ω–æ–≤</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-avg">0</div>
      <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ</div>
    </div>
  </div>

  <!-- Main Card -->
  <div class="card">
    <!-- API Key Setup -->
    <div id="api-setup" class="api-setup">
      <h3>üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini API</h3>
      <p>–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com</a></p>
      <input type="password" id="api-key" class="input-field" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ API –∫–ª—é—á (AIza...)" style="margin-bottom: 8px;">
      <button class="btn btn-primary" onclick="saveApiKey()" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á</button>
    </div>

    <!-- Upload Zone -->
    <div id="upload-zone" class="upload-zone hidden" onclick="document.getElementById('file-input').click()">
      <div class="icon">üì∏</div>
      <div class="text">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø–∞–ª–ª–µ—Ç—É</div>
      <div class="hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ</div>
    </div>
    
    <input type="file" id="file-input" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(event)">
    
    <div id="camera-btns" class="btn-row hidden">
      <button class="btn btn-secondary" onclick="document.getElementById('camera-input').click()">
        üì∑ –ö–∞–º–µ—Ä–∞
      </button>
      <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(event)">
    </div>

    <!-- Image Preview -->
    <div id="image-preview" class="image-container hidden">
      <img id="preview-img" src="" alt="Preview">
      <button class="close-btn" onclick="clearImage()">‚úï</button>
      <div id="markers-overlay" class="markers-overlay"></div>
    </div>

    <!-- Pallet ID -->
    <input type="text" id="pallet-id" class="input-field hidden" placeholder="ID –ø–∞–ª–ª–µ—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">

    <!-- Count Button -->
    <button id="count-btn" class="btn btn-primary hidden" onclick="countRolls()" style="width: 100%;">
      üöÄ –ü–æ—Å—á–∏—Ç–∞—Ç—å —Ä—É–ª–æ–Ω—ã
    </button>

    <!-- Loading -->
    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <div class="loading-text">Gemini –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ...</div>
    </div>

    <!-- Result -->
    <div id="result" class="result-box hidden">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <div class="result-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–ª–æ–Ω–æ–≤</div>
          <div class="result-count" id="result-count">0</div>
        </div>
        <span id="confidence-badge" class="confidence-badge confidence-high">–í—ã—Å–æ–∫–∞—è</span>
      </div>
      <div id="result-details" class="result-details"></div>
      <input type="text" id="notes" class="input-field" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ..." style="margin-top: 12px; margin-bottom: 0;">
    </div>

    <!-- Error -->
    <div id="error" class="error-box hidden">
      <div style="font-size: 32px; margin-bottom: 8px;">‚ö†Ô∏è</div>
      <div id="error-text">–û—à–∏–±–∫–∞</div>
      <button class="btn btn-secondary" onclick="countRolls()" style="margin-top: 12px;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>

    <!-- Action Buttons -->
    <div id="action-btns" class="btn-row hidden">
      <button class="btn btn-success" onclick="saveToHistory()">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="countRolls()">üîÑ</button>
    </div>
  </div>

  <!-- History -->
  <div id="history-section" class="card hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h3 style="font-size: 16px;">üìã –ò—Å—Ç–æ—Ä–∏—è</h3>
      <div>
        <button class="toggle-btn" onclick="toggleHistory()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button class="toggle-btn" onclick="exportCSV()">üì• CSV</button>
      </div>
    </div>
    <div id="history-list"></div>
  </div>

  <script>
    // State
    let currentImage = null;
    let currentResult = null;
    let history = [];
    let apiKey = '';

    // Load saved data
    try {
      apiKey = localStorage.getItem('gemini_api_key') || '';
      history = JSON.parse(localStorage.getItem('roll_history') || '[]');
    } catch(e) {}

    // Init
    function init() {
      if (apiKey) {
        document.getElementById('api-setup').classList.add('hidden');
        document.getElementById('upload-zone').classList.remove('hidden');
        document.getElementById('camera-btns').classList.remove('hidden');
      }
      updateStats();
      renderHistory();
    }

    function saveApiKey() {
      const key = document.getElementById('api-key').value.trim();
      if (!key) return alert('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á');
      
      apiKey = key;
      try { localStorage.setItem('gemini_api_key', key); } catch(e) {}
      
      document.getElementById('api-setup').classList.add('hidden');
      document.getElementById('upload-zone').classList.remove('hidden');
      document.getElementById('camera-btns').classList.remove('hidden');
    }

    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        currentImage = {
          dataUrl: e.target.result,
          base64: e.target.result.split(',')[1],
          mimeType: file.type
        };
        
        document.getElementById('preview-img').src = currentImage.dataUrl;
        document.getElementById('upload-zone').classList.add('hidden');
        document.getElementById('camera-btns').classList.add('hidden');
        document.getElementById('image-preview').classList.remove('hidden');
        document.getElementById('pallet-id').classList.remove('hidden');
        document.getElementById('count-btn').classList.remove('hidden');
        
        // Clear previous
        document.getElementById('result').classList.add('hidden');
        document.getElementById('error').classList.add('hidden');
        document.getElementById('action-btns').classList.add('hidden');
        document.getElementById('markers-overlay').innerHTML = '';
        currentResult = null;
      };
      reader.readAsDataURL(file);
    }

    function clearImage() {
      currentImage = null;
      currentResult = null;
      document.getElementById('image-preview').classList.add('hidden');
      document.getElementById('pallet-id').classList.add('hidden');
      document.getElementById('count-btn').classList.add('hidden');
      document.getElementById('result').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
      document.getElementById('action-btns').classList.add('hidden');
      document.getElementById('upload-zone').classList.remove('hidden');
      document.getElementById('camera-btns').classList.remove('hidden');
      document.getElementById('markers-overlay').innerHTML = '';
      document.getElementById('file-input').value = '';
      document.getElementById('camera-input').value = '';
    }

    async function countRolls() {
      if (!currentImage || !apiKey) return;

      document.getElementById('count-btn').classList.add('hidden');
      document.getElementById('result').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
      document.getElementById('action-btns').classList.add('hidden');
      document.getElementById('loading').classList.remove('hidden');

      const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–¥—Å—á—ë—Ç—É —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ. –ù–∞ —Ñ–æ—Ç–æ –ø–∞–ª–ª–µ—Ç–∞ —Å —Ä—É–ª–æ–Ω–∞–º–∏.

–ó–ê–î–ê–ß–ê: –ü–æ–¥—Å—á–∏—Ç–∞–π –¢–û–ß–ù–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–ª–æ–Ω–æ–≤ –Ω–∞ –¶–ï–ù–¢–†–ê–õ–¨–ù–û–ô/–û–°–ù–û–í–ù–û–ô –ø–∞–ª–ª–µ—Ç–µ.

–ú–ï–¢–û–î –ü–û–î–°–ß–Å–¢–ê:
1. –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å–º–æ—Ç—Ä–∏ –µ—Å—Ç—å –ª–∏ —ç—Ç–∏–∫–µ—Ç–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º - –µ—Å–ª–∏ –¥–∞, –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∫—É
2. –ü–æ–¥—Å—á–∏—Ç–∞–π –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —Ç–æ—Ä—Ü—ã —Ä—É–ª–æ–Ω–æ–≤ —Ä—è–¥ –∑–∞ —Ä—è–¥–æ–º (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ)
3. –£—á—Ç–∏ —á—Ç–æ —Ñ–æ—Ç–æ –ø–æ–¥ —É–≥–ª–æ–º - –¥–∞–ª—å–Ω–∏–µ —Ä—É–ª–æ–Ω—ã (–≤–≤–µ—Ä—Ö—É) –≤—ã–≥–ª—è–¥—è—Ç –º–µ–Ω—å—à–µ
4. –û—Ü–µ–Ω–∏ —Å–∫–æ–ª—å–∫–æ —Ä—É–ª–æ–Ω–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç–æ –∑–∞ —ç—Ç–∏–∫–µ—Ç–∫–æ–π/–ª–∏—Å—Ç–æ–º
5. –ù–ï —Å—á–∏—Ç–∞–π —Ä—É–ª–æ–Ω—ã –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–∞–ª–ª–µ—Ç–∞—Ö –Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON):
{
  "count": <–∏—Ç–æ–≥–æ–≤–æ–µ —á–∏—Å–ª–æ —Ä—É–ª–æ–Ω–æ–≤>,
  "visible_count": <—á–∏—Å–ª–æ –≤–∏–¥–∏–º—ã—Ö —Ä—É–ª–æ–Ω–æ–≤>,
  "hidden_estimate": <–æ—Ü–µ–Ω–∫–∞ —Å–∫—Ä—ã—Ç—ã—Ö>,
  "confidence": "high" | "medium" | "low",
  "method": "<–∫–∞–∫ —Å—á–∏—Ç–∞–ª: –ø–æ —ç—Ç–∏–∫–µ—Ç–∫–µ / –≤–∏–∑—É–∞–ª—å–Ω–æ / –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ>",
  "layout": "<–ø—Ä–∏–º–µ—Ä–Ω–æ —Ä—è–¥–æ–≤ x —Å—Ç–æ–ª–±—Ü–æ–≤>",
  "explanation": "<–∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ–¥—Å—á—ë—Ç–∞>",
  "markers": [
    {"x": <0-100>, "y": <0-100>}
  ]
}

–ü–æ–ª–µ markers - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–æ–≤ –≤–∏–¥–∏–º—ã—Ö —Ä—É–ª–æ–Ω–æ–≤ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (x=0 –ª–µ–≤—ã–π –∫—Ä–∞–π, y=0 –≤–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π).
–ï—Å–ª–∏ —Ä—É–ª–æ–Ω–æ–≤ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ (>50), –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞.`;

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { inlineData: { mimeType: currentImage.mimeType, data: currentImage.base64 } },
                  { text: prompt }
                ]
              }],
              generationConfig: { temperature: 0.1, maxOutputTokens: 4096 }
            })
          }
        );

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message || 'API Error');
        }

        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        
        if (!jsonMatch) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç');
        
        currentResult = JSON.parse(jsonMatch[0]);
        showResult();

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('error-text').textContent = error.message;
        document.getElementById('error').classList.remove('hidden');
      } finally {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('count-btn').classList.remove('hidden');
      }
    }

    function showResult() {
      if (!currentResult) return;

      document.getElementById('result-count').textContent = currentResult.count || 0;
      
      // Confidence badge
      const badge = document.getElementById('confidence-badge');
      badge.className = 'confidence-badge';
      if (currentResult.confidence === 'high') {
        badge.classList.add('confidence-high');
        badge.textContent = '–í—ã—Å–æ–∫–∞—è';
      } else if (currentResult.confidence === 'medium') {
        badge.classList.add('confidence-medium');
        badge.textContent = '–°—Ä–µ–¥–Ω—è—è';
      } else {
        badge.classList.add('confidence-low');
        badge.textContent = '–ù–∏–∑–∫–∞—è';
      }

      // Details
      let details = '';
      if (currentResult.method) details += `üìä –ú–µ—Ç–æ–¥: ${currentResult.method}\n`;
      if (currentResult.layout) details += `üìê –£–∫–ª–∞–¥–∫–∞: ${currentResult.layout}\n`;
      if (currentResult.visible_count) details += `üëÅ –í–∏–¥–∏–º—ã—Ö: ${currentResult.visible_count}\n`;
      if (currentResult.hidden_estimate) details += `üîí –°–∫—Ä—ã—Ç—ã—Ö: ~${currentResult.hidden_estimate}\n`;
      if (currentResult.explanation) details += `\n${currentResult.explanation}`;
      
      document.getElementById('result-details').textContent = details.trim();
      
      // Markers
      const overlay = document.getElementById('markers-overlay');
      overlay.innerHTML = '';
      
      if (currentResult.markers && currentResult.markers.length > 0) {
        currentResult.markers.forEach(m => {
          const marker = document.createElement('div');
          marker.className = 'marker';
          marker.style.left = m.x + '%';
          marker.style.top = m.y + '%';
          overlay.appendChild(marker);
        });
      }

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('action-btns').classList.remove('hidden');
    }

    function saveToHistory() {
      if (!currentResult || !currentImage) return;

      const entry = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('ru-RU'),
        palletId: document.getElementById('pallet-id').value || `–ü–∞–ª–ª–µ—Ç–∞ ${history.length + 1}`,
        image: currentImage.dataUrl,
        count: currentResult.count || 0,
        confidence: currentResult.confidence,
        layout: currentResult.layout,
        method: currentResult.method,
        notes: document.getElementById('notes').value
      };

      history.unshift(entry);
      try { localStorage.setItem('roll_history', JSON.stringify(history)); } catch(e) {}
      
      updateStats();
      renderHistory();
      clearImage();
      document.getElementById('pallet-id').value = '';
      document.getElementById('notes').value = '';
    }

    function updateStats() {
      if (history.length === 0) {
        document.getElementById('stats').classList.add('hidden');
        return;
      }
      
      document.getElementById('stats').classList.remove('hidden');
      document.getElementById('stat-pallets').textContent = history.length;
      
      const totalRolls = history.reduce((sum, h) => sum + (h.count || 0), 0);
      document.getElementById('stat-rolls').textContent = totalRolls;
      document.getElementById('stat-avg').textContent = Math.round(totalRolls / history.length);
    }

    function renderHistory() {
      if (history.length === 0) {
        document.getElementById('history-section').classList.add('hidden');
        return;
      }
      
      document.getElementById('history-section').classList.remove('hidden');
      const list = document.getElementById('history-list');
      list.innerHTML = history.slice(0, 10).map(h => `
        <div class="history-item">
          <img src="${h.image}" alt="">
          <div class="info">
            <div class="title">${h.palletId}</div>
            <div class="time">${h.timestamp}</div>
          </div>
          <div class="count">${h.count}</div>
        </div>
      `).join('');
    }

    function toggleHistory() {
      const list = document.getElementById('history-list');
      list.classList.toggle('hidden');
    }

    function exportCSV() {
      if (history.length === 0) return;
      
      const csv = [
        'ID;–í—Ä–µ–º—è;–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ;–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å;–£–∫–ª–∞–¥–∫–∞;–ú–µ—Ç–æ–¥;–ü—Ä–∏–º–µ—á–∞–Ω–∏—è',
        ...history.map(h => 
          `${h.palletId};${h.timestamp};${h.count};${h.confidence};${h.layout || ''};${h.method || ''};${h.notes || ''}`
        )
      ].join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    // Initialize
    init();
  </script>
</body>
</html>
